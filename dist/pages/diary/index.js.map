{"version":3,"sources":["pages/diary/index.js"],"names":["app","getApp","globalData","Page","data","avatarUrl","nickname","getScope","success","fail","name","wx","getSetting","res","authSetting","_getUserInfo","cb","getUserInfo","userInfo","rs","setData","that","openid","getStorageSync","callback","getUserOpenId","result","console","log","login","code","then","onLoad","auth","goBack","navigateBack","onShareAppMessage","title","path"],"mappings":";;AACA;;AACA;;AACA;AACA;;;AAJA;AAOA,IAAMA,MAAMC,QAAZ;AACA,IAAMC,aAAaF,IAAIE,UAAvB;AACAC,KAAK;AACHC,QAAM;AACJC,eAAWH,WAAWG,SADlB;AAEJC,cAAUJ,WAAWI;AAFjB,GADH;AAKH;AACAC,UANG,oBAMMC,QANN,EAMeC,IANf,EAM4C;AAAA,QAAvBC,IAAuB,uEAAlB,gBAAkB;;AAC7CC,OAAGC,UAAH,CAAc;AACZJ,eAAS,iBAACK,GAAD,EAAS;AAChB,YAAIA,IAAIC,WAAJ,CAAgBJ,IAAhB,CAAJ,EAA2B;AACzB;AACA;AACA;AACA,iBAAOF,QAAP,KAAmB,UAAnB,IAAiCA,UAAjC;AACD,SALD,MAKO;AACL,iBAAOC,IAAP,KAAgB,UAAhB,IAA8BA,MAA9B;AACA;AACA;AACD;AACF;AAZW,KAAd;AAcD,GArBE;;AAsBH;AACA;AACAM,cAxBG,0BAwByB;AAAA,QAAfC,EAAe,uEAAV,YAAM,CAAE,CAAE;;AAC1BL,OAAGM,WAAH,CAAe;AACbT,eAAS,iBAACK,GAAD,EAAS;AAChBG,WAAGH,IAAIK,QAAP;AACD;AAHY,KAAf;AAKD,GA9BE;AA+BHD,aA/BG,yBA+BW;AAAA;;AACZ;AACA,QAAI,CAACf,WAAWI,QAAZ,IAAwBJ,WAAWG,SAAvC,EAAkD;AAChD;AACA,WAAKU,YAAL,CAAkB,UAACI,EAAD,EAAQ;AACxB,cAAKC,OAAL,CAAa;AACXd,oBAAUa,GAAGb,QADF;AAEXD,qBAAWc,GAAGd;AAFH,SAAb;AAIM;AACR;AACA;AACC,OARD;AASD;AACD,QAAMgB,OAAO,IAAb;AACA,QAAIC,SAASX,GAAGY,cAAH,CAAkB,QAAlB,CAAb;AACA;AACA,aAASC,QAAT,GAAoB,CACnB;AACD,QAAIF,MAAJ,EAAY;AACVE;AACD,KAFD,MAEO;AACL,WAAKC,aAAL;AACE;AACA,gBAACZ,GAAD,EAAS;AACPS,iBAAST,IAAIa,MAAJ,CAAWJ,MAApB;AACAE;AACD,OALH;AAME;AACA,kBAAM;AACJG,gBAAQC,GAAR,CAAY,MAAZ;AACD,OATH;AAWD;AACF,GAjEE;AAkEHH,eAlEG,yBAkEWjB,OAlEX,EAkEoBC,IAlEpB,EAkE0B;AAC3BE,OAAGkB,KAAH,CAAS;AACPrB,eAAS,iBAACK,GAAD,EAAS;AAChBc,gBAAQC,GAAR,CAAY,MAAZ,EAAoBf,IAAIiB,IAAxB;AACF;AACA,qCAAejB,IAAIiB,IAAnB,EAAyBC,IAAzB,CAA8B,UAAClB,GAAD,EAAS;AACrC;AACAc,kBAAQC,GAAR,CAAY,OAAZ,EAAqBE,IAArB;AACD,SAHD;AAIC;AARM,KAAT;AAUD,GA7EE;AA8EHE,QA9EG,oBA8EM;AAAA;;AACP,SAAKZ,OAAL,CAAa;AACX;AADW,KAAb;AAGA,SAAKK,aAAL;AACA;AACA,SAAKlB,QAAL,CAAc,KAAKU,WAAnB,EAAgC,YAAM;AACpC,aAAKG,OAAL,CAAa,EAAEa,MAAM,CAAR,EAAb;AACD,KAFD;AAGD,GAvFE;;AAwFH;AACAC,QAzFG,oBAyFM;AACPvB,OAAGwB,YAAH;AACD,GA3FE;AA4FHC,mBA5FG,+BA4FiB;AAClB,WAAO;AACLC,aAAO,sBADF;AAELC,YAAM;AAFD,KAAP;AAID;AAjGE,CAAL","file":"index.js","sourcesContent":["/*<remove trigger=\"prod\">*/\nimport { jscode2session } from '../../lib/api-mock'\nimport { getEmotionByOpenidAndDate, addEmotion } from '../../lib/api'\n/*</remove>*/\n/*<jdists trigger=\"prod\">\nimport {getEmotionByOpenidAndDate, addEmotion, jscode2session} from '../../lib/api'\n</jdists>*/\nconst app = getApp()\nconst globalData = app.globalData;\nPage({\n  data: {\n    avatarUrl: globalData.avatarUrl,\n    nickname: globalData.nickname,\n  },\n  // 获取用户权限信息, 参数是可以临时加的？对的\n  getScope(success, fail, name=\"scope.userInfo\") {\n    wx.getSetting({\n      success: (res) => {\n        if (res.authSetting[name]) {\n          // 已经授权，可以直接调用 getUserInfo 获取头像昵称\n          // 这里的success就是传过来的参数 this.getUserInfo\n          // 还得判断一下参数是否为function\n          typeof success === 'function' && success()\n        } else {\n          typeof fail === 'function' && fail()\n          // console.log('显示登录授权', this.data.auth)\n          // 显示登录授权\n        }\n      }\n    })\n  },\n  // 获取用户信息\n  // 每个小功能都封装成函数\n  _getUserInfo(cb = () => {}) {\n    wx.getUserInfo({\n      success: (res) => {\n        cb(res.userInfo)\n      }\n    })\n  },\n  getUserInfo() {\n    //  如果用户不存在全局数据， 也就是globalData里面没有，就获取\n    if (!globalData.nickname || globalData.avatarUrl) {\n      // 这个函数不做数据的处理，\n      this._getUserInfo((rs) => {\n        this.setData({\n          nickname: rs.nickname,\n          avatarUrl: rs.avatarUrl\n        })\n              // 然后再存入全局\n      // globalData.nickname = rs.nickname;\n      // globalData.avatarUrl = rs.avatarUrl\n      })\n    }\n    const that = this;\n    let openid = wx.getStorageSync('openid');\n    // 逻辑数据的处理回调\n    function callback() {\n    }\n    if (openid) {\n      callback();\n    } else {\n      this.getUserOpenId(\n        // 成功的回调\n        (res) => {\n          openid = res.result.openid;\n          callback()\n        },\n        // 获取openid 失败的回调\n        () => {\n          console.log('授权失败')\n        }\n      )\n    }\n  },\n  getUserOpenId(success, fail) {\n    wx.login({\n      success: (res) => {\n        console.log('code', res.code)        \n      // 传临时登陆凭证code\n      jscode2session(res.code).then((res) => {\n        // 没有返回\n        console.log('code2', code)\n      })\n      }\n    })\n  },\n  onLoad() {\n    this.setData({\n      // curMonth: dataFormat(new Date(), 'yyy-MM')\n    })\n    this.getUserOpenId()\n    // 另一个参数是失败时的回调函数\n    this.getScope(this.getUserInfo, () => {\n      this.setData({ auth: 0 })\n    })\n  },\n  // 返回\n  goBack() {\n    wx.navigateBack()\n  },\n  onShareAppMessage() {\n    return {\n      title: '我发现了一个好玩的小程序，分享给你看看！',\n      path: '/pages/diary/index'\n    }\n  }\n})"]}